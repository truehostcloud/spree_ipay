name: Run RSpec Tests

on:
  push:
    branches: [ main, master, ipay-feature-update1 ]
  pull_request:
    branches: [ main, master, ipay-feature-update1 ]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      RAILS_ENV: test
      DISABLE_SPRING: 1
      RAILS_MASTER_KEY: 1234567890abcdef1234567890abcdef
      SECRET_KEY_BASE: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef

    steps:
    - uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.3.6
        bundler-cache: true
        bundler: 2.4.22

    - name: Set up test database
      run: |
        # Create test app directory
        mkdir -p spec/dummy
        cd spec/dummy
        
        # Create a basic Rails app with SQLite
        bundle _2.4.22_ exec rails new . --force \
          --skip-bootsnap \
          --skip-jbuilder \
          --skip-test \
          --skip-system-test \
          --skip-turbolinks \
          --skip-webpack-install \
          --skip-sprockets \
          --database=sqlite3
        
        # Add Spree and testing gems to Gemfile
        echo -e '\n# Spree\ngem "spree", "~> 4.6.0"\ngem "spree_gateway", "~> 3.10.0"\ngem "spree_auth_devise", "~> 4.6.0"\ngem "spree_extension", "~> 0.1.0"\ngem "spree_ipay", path: "../.."\n\n# Ransack with Rails 7.1 compatibility\ngem "ransack", github: "activerecord-hackery/ransack", branch: "master"\n\n# Testing\ngroup :development, :test do\n  gem "rspec-rails", "~> 6.1.0"\n  gem "factory_bot_rails", "~> 6.2.0"\n  gem "database_cleaner", "~> 2.0"\n  gem "shoulda-matchers", "~> 5.0"\nend' >> Gemfile

        # Install gems
        bundle _2.4.22_ install --verbose
        
        # Install RSpec
        bundle _2.4.22_ exec rails generate rspec:install
        
        # Run Spree install
        bundle _2.4.22_ exec rails g spree:install --auto-accept --user_class=Spree::User
        bundle _2.4.22_ exec rails g spree:auth:install
        bundle _2.4.22_ exec rails g spree_gateway:install
        
        # Set up database
        bundle _2.4.22_ exec rails db:create
        bundle _2.4.22_ exec rails db:migrate
        
        # Generate RSpec binstub
        bundle _2.4.22_ binstubs rspec-core

    - name: Run tests
      run: |
        cd spec/dummy
        # Use the binstub to run RSpec
        bin/rspec ../../spec
