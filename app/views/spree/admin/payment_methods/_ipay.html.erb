<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">iPay Payment Settings</h5>
      </div>
      <div class="card-body">
        <!-- Main Configurations -->
        <div class="form-group mb-3">
          <%= label_tag :vendor_id, "Vendor ID" %>
          <%= preference_field_tag(
            "payment_method[preferred_vendor_id]",
            @payment_method.preferred_vendor_id,
            type: :string,
            class: 'form-control'
          ) %>
        </div>

        <div class="form-group mb-3">
          <%= label_tag :hash_key, "Hash Key" %>
          <%= preference_field_tag(
            "payment_method[preferred_hash_key]",
            @payment_method.preferred_hash_key,
            type: :password,
            class: 'form-control'
          ) %>
        </div>

        <div class="form-group mb-3">
          <%= label_tag :currency, "Currency" %>
          <%= preference_field_tag(
            "payment_method[preferred_currency]",
            @payment_method.preferred_currency || 'KES',
            type: :string,
            class: 'form-control'
          ) %>
        </div>

        <div class="form-group mb-3">
          <%= label_tag :callback_url, "Callback URL" %>
          <%= preference_field_tag(
            "payment_method[preferred_callback_url]",
            @payment_method.preferred_callback_url,
            type: :string,
            class: 'form-control',
            placeholder: 'https://yourdomain.com/api/v1/ipay/:payment_id/callback'
          ) %>
        </div>

        <div class="form-group mb-4">
          <%= label_tag :return_url, "Return URL" %>
          <%= preference_field_tag(
            "payment_method[preferred_return_url]",
            @payment_method.preferred_return_url,
            type: :string,
            class: 'form-control',
            placeholder: 'https://yourdomain.com/ipay/checkout/:id'
          ) %>
        </div>

        <!-- Test Mode just before payment channels -->
        <hr>
        <div class="form-group mb-4">
          <%= label_tag :test_mode, "Test Mode", class: "form-label" %>
          <div>
            <%= preference_field_tag(
              "payment_method[preferred_test_mode]",
              @payment_method.preferred_test_mode,
              type: :boolean,
              class: 'form-check-input'
            ) %>
            <%= label_tag "payment_method_preferred_test_mode", "Enable Test Mode", class: "form-check-label ms-2" %>
            <small class="form-text text-muted ms-3">
              Enable test mode to use iPay's sandbox environment.
            </small>
          </div>
        </div>

        <!-- Payment Channels Section -->
        <h6 class="mt-4">Payment Channels</h6>
        <div class="form-group">
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_mpesa]",
              @payment_method.preferred_channel_mpesa,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_mpesa'
            ) %>
            <%= label_tag 'channel_mpesa', 'M-PESA', class: 'form-check-label' %>
          </div>
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_airtel]",
              @payment_method.preferred_channel_airtel,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_airtel'
            ) %>
            <%= label_tag 'channel_airtel', 'Airtel Money', class: 'form-check-label' %>
          </div>
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_equitel]",
              @payment_method.preferred_channel_equitel,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_equitel'
            ) %>
            <%= label_tag 'channel_equitel', 'Equitel', class: 'form-check-label' %>
          </div>
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_visa]",
              @payment_method.preferred_channel_visa,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_visa'
            ) %>
            <%= label_tag 'channel_visa', 'VISA/MasterCard', class: 'form-check-label' %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">iPay Payment Settings</h5>
      </div>
      <div class="card-body">
        <!-- Test Mode at the top -->
        <div class="form-group mb-4">
          <%= label_tag :test_mode, "Test Mode", class: "form-label" %>
          <div>
            <%= preference_field_tag(
              "payment_method[preferred_test_mode]",
              @payment_method.preferred_test_mode,
              type: :boolean,
              class: 'form-check-input'
            ) %>
            <%= label_tag "payment_method_preferred_test_mode", "Enable Test Mode", class: "form-check-label ms-2" %>
            <small class="form-text text-muted ms-3">
              Enable test mode to use iPay's sandbox environment.
            </small>
          </div>
        </div>

        <!-- Main Configurations -->
        <div class="form-group mb-3">
          <%= label_tag :vendor_id, "Vendor ID" %>
          <%= preference_field_tag(
            "payment_method[preferred_vendor_id]",
            @payment_method.preferred_vendor_id,
            type: :string,
            class: 'form-control'
          ) %>
        </div>

        <div class="form-group mb-3">
          <%= label_tag :hash_key, "Hash Key" %>
          <%= preference_field_tag(
            "payment_method[preferred_hash_key]",
            @payment_method.preferred_hash_key,
            type: :password,
            class: 'form-control'
          ) %>
        </div>

        <div class="form-group mb-3">
          <%= label_tag :currency, "Currency" %>
          <%= preference_field_tag(
            "payment_method[preferred_currency]",
            @payment_method.preferred_currency || 'KES',
            type: :string,
            class: 'form-control'
          ) %>
        </div>

        <div class="form-group mb-3">
          <%= label_tag :callback_url, "Callback URL" %>
          <%= preference_field_tag(
            "payment_method[preferred_callback_url]",
            @payment_method.preferred_callback_url,
            type: :string,
            class: 'form-control',
            placeholder: 'https://yourdomain.com/api/v1/ipay/:payment_id/callback'
          ) %>
        </div>

        <div class="form-group mb-4">
          <%= label_tag :return_url, "Return URL" %>
          <%= preference_field_tag(
            "payment_method[preferred_return_url]",
            @payment_method.preferred_return_url,
            type: :string,
            class: 'form-control',
            placeholder: 'https://yourdomain.com/ipay/checkout/:id'
          ) %>
        </div>

        <!-- Payment Channels Section -->
        <hr>
        <h6 class="mt-4">Payment Channels</h6>
        <div class="form-group">
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_mpesa]",
              @payment_method.preferred_channel_mpesa,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_mpesa'
            ) %>
            <%= label_tag 'channel_mpesa', 'M-PESA', class: 'form-check-label' %>
          </div>
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_airtel]",
              @payment_method.preferred_channel_airtel,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_airtel'
            ) %>
            <%= label_tag 'channel_airtel', 'Airtel Money', class: 'form-check-label' %>
          </div>
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_equitel]",
              @payment_method.preferred_channel_equitel,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_equitel'
            ) %>
            <%= label_tag 'channel_equitel', 'Equitel', class: 'form-check-label' %>
          </div>
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_visa]",
              @payment_method.preferred_channel_visa,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_visa'
            ) %>
            <%= label_tag 'channel_visa', 'VISA/MasterCard', class: 'form-check-label' %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">iPay Payment Settings</h5>
      </div>
      <div class="card-body">
        <div class="form-group">
          <%= label_tag :test_mode, Spree.t(:test_mode) %>
          <div class="mt-2">
            <%= preference_field_tag(
              "payment_method[preferred_test_mode]",
              @payment_method.preferred_test_mode,
              type: :boolean
            ) %>
          </div>
        </div>

        <div class="form-group">
          <%= label_tag :vendor_id, "Vendor ID" %>
          <%= preference_field_tag(
            "payment_method[preferred_vendor_id]",
            @payment_method.preferred_vendor_id,
            type: :string,
            class: 'form-control'
          ) %>
        </div>

        <div class="form-group">
          <%= label_tag :hash_key, "Hash Key" %>
          <%= preference_field_tag(
            "payment_method[preferred_hash_key]",
            @payment_method.preferred_hash_key,
            type: :password,
            class: 'form-control'
          ) %>
        </div>

        <!-- Add other fields as needed -->
        <div class="form-group">
          <%= label_tag :currency, "Currency" %>
          <%= preference_field_tag(
            "payment_method[preferred_currency]",
            @payment_method.preferred_currency || 'KES',
            type: :string,
            class: 'form-control'
          ) %>
        </div>

        <div class="form-group">
          <%= label_tag :callback_url, "Callback URL" %>
          <%= preference_field_tag(
            "payment_method[preferred_callback_url]",
            @payment_method.preferred_callback_url,
            type: :string,
            class: 'form-control',
            placeholder: 'https://yourdomain.com/api/v1/ipay/:payment_id/callback'
          ) %>
          <small class="form-text text-muted">
            <strong>Required:</strong> Copy this Callback URL into your iPay merchant dashboard settings.<br>
            <strong>This URL must be accessible from the public internet</strong> (iPay servers cannot reach localhost).<br>
            <strong>Example:</strong> <code>https://yourdomain.com/api/v1/ipay/:payment_id/callback</code><br>
            Replace <code>:payment_id</code> with the actual payment id if required by iPay.<br>
            <strong>Tip:</strong> Use your current ngrok address while developing locally.<br>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="copyToClipboard('[name=\'payment_method[preferred_callback_url]\']')">Copy Callback URL</button>
          </small>
        </div>
        <div class="form-group">
          <%= label_tag :return_url, "Return URL" %>
          <%= preference_field_tag(
            "payment_method[preferred_return_url]",
            @payment_method.preferred_return_url,
            type: :string,
            class: 'form-control',
            placeholder: 'https://yourdomain.com/ipay/checkout/:id'
          ) %>
          <small class="form-text text-muted">
            <strong>Required:</strong> Copy this Return URL into your iPay merchant dashboard settings.<br>
            This is where the customer will be redirected after payment.<br>
            <strong>Example:</strong> <code>https://yourdomain.com/ipay/checkout/:id</code><br>
            Replace <code>:id</code> with the order number or id as needed.<br>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="copyToClipboard('[name=\'payment_method[preferred_return_url]\']')">Copy Return URL</button>
          </small>
        </div>
        <!-- Payment Channels Section -->
        <hr>
        <h6 class="mt-4">Payment Channels</h6>
        <div class="form-group">
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_mpesa]",
              @payment_method.preferred_channel_mpesa,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_mpesa'
            ) %>
            <%= label_tag 'channel_mpesa', 'M-PESA', class: 'form-check-label' %>
          </div>
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_airtel]",
              @payment_method.preferred_channel_airtel,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_airtel'
            ) %>
            <%= label_tag 'channel_airtel', 'Airtel Money', class: 'form-check-label' %>
          </div>
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_equitel]",
              @payment_method.preferred_channel_equitel,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_equitel'
            ) %>
            <%= label_tag 'channel_equitel', 'Equitel', class: 'form-check-label' %>
          </div>
          <div class="form-check">
            <%= preference_field_tag(
              "payment_method[preferred_channel_visa]",
              @payment_method.preferred_channel_visa,
              type: :boolean,
              class: 'form-check-input',
              id: 'channel_visa'
            ) %>
            <%= label_tag 'channel_visa', 'VISA/MasterCard', class: 'form-check-label' %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Basic debounce implementation
function debounce(func, wait) {
  let timeout;
  return function() {
    const context = this, args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(context, args), wait);
  };
}

// Copy to clipboard helper
function copyToClipboard(selector) {
  var input = document.querySelector(selector);
  if (input) {
    input.select();
    document.execCommand('copy');
    alert('Copied to clipboard!');
  }
}

// Example: Debounced logging for callback_url and return_url fields
function setupDebouncedLogging() {
  var callbackInput = document.querySelector('[name="payment_method[preferred_callback_url]"]');
  var returnInput = document.querySelector('[name="payment_method[preferred_return_url]"]');

  if (callbackInput) {
    callbackInput.addEventListener('input', debounce(function(e) {
      console.log('Callback URL changed to:', e.target.value);
      // Place any AJAX or validation logic here
    }, 500));
  }
  if (returnInput) {
    returnInput.addEventListener('input', debounce(function(e) {
      console.log('Return URL changed to:', e.target.value);
      // Place any AJAX or validation logic here
    }, 500));
  }
}

document.addEventListener('DOMContentLoaded', setupDebouncedLogging);
</script>
