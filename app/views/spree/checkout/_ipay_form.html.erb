<% 
  payment_method = local_assigns[:ipay_method] || @ipay_method
  payment = local_assigns[:payment] || @payment
  phone = local_assigns[:phone] || @phone
  
  # Get required values from payment method preferences
  live = payment_method.preferred_test_mode ? '0' : '1'
  oid = payment.order.number
  inv = "#{payment.order.number}#{Time.now.to_i}" # unique invoice
  ttl = (payment.amount.to_f * 100).to_i.to_s # Amount in cents
  eml = payment.order.email
  vid = payment_method.preferred_vendor_id.presence || ''
  curr = payment_method.preferred_currency.presence || 'KES'
  p1 = ""
  p2 = ""
  p3 = ""
  p4 = ""
  cbk = payment_method.preferred_callback_url.presence || "https://example.com/ipay/callback"
  cst = "1"
  crl = "2"
  
  # Generate the hash with the phone number
  hsh = payment_method.ipay_signature_hash(payment, phone)

  # Prepare iPay parameters
  ipay_params = {
    'live' => live,
    'oid' => oid,
    'inv' => inv,
    'ttl' => ttl,
    'tel' => phone || '0700000000',
    'eml' => eml,
    'vid' => vid,
    'curr' => curr,
    'p1' => p1,
    'p2' => p2,
    'p3' => p3,
    'p4' => p4,
    'cbk' => cbk,
    'cst' => cst,
    'crl' => crl,
    'hsh' => hsh
  }

  # Add channel parameters based on preferences
  %i[
    mpesa bonga airtel equity mobilebanking
    creditcard unionpay mvisa vooma pesalink autopay
  ].each do |channel|
    ipay_params[channel.to_s] = payment_method.public_send("preferred_#{channel}") ? '1' : '0'
  end
%>

<p class="text-sm sm:text-base text-gray-500 text-center mb-4">If you are not redirected automatically, please click the button below.</p>

<form id="ipay-payment-form" 
      action="<%= payment_method.preferred_test_mode ? 'https://payments.ipayafrica.com/v3/ke' : 'https://payments.ipayafrica.com/v3/ke' %>" 
      method="post" 
      class="flex flex-col items-center space-y-4">
  <% ipay_params.each do |key, value| %>
    <input type="hidden" name="<%= key %>" value="<%= value %>">
  <% end %>
  
  <button type="submit" 
          class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-blue-700 transition duration-300 w-full sm:w-auto">
    Proceed to Payment
  </button>
</form>

<script nonce="<%= content_security_policy_nonce %>">
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      document.getElementById('ipay-payment-form').submit();
    }, 1000);
  });
</script>
